<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=<device-width>, initial-scale=1.0" />
		<title>Chỉnh tài liệu</title>
		<link />
		<link
			rel="shortcut icon"
			href="static/images/HCMUT_official_logo.ico"
			type="image/x-icon" />
		<style>
			html,
			body {
				overflow-x: hidden;
				margin: 0;
				padding: 0;
			}
		</style>
		<link rel="stylesheet" href={{ url_for('static', filename='css/navbar.css')}} /> 
		<link rel="stylesheet" href={{ url_for('static', filename='css/file_config.css') }} />
		<link rel="stylesheet" href={{ url_for('static', filename='css/noti_box.css') }} />
		<link rel="stylesheet" href={{ url_for('static', filename='css/chatbox.css') }} />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	</head>
	<body>
		<div id="root"></div>
		<link
			href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap"
			rel="stylesheet" />
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<div id="document-config">
			<div id="navbar">
				<div
					id="logo"
					style="
						width: 285.6px;
						height: 57.6px;
						left: 40px;
						top: 5.6px;
						position: absolute;
					">
					<div
						style="
							width: 255px;
							height: 53.6px;
							left: 17.6px;
							top: 0px;
							position: absolute;
							background: #142c64;
							border-radius: 16px;
						"></div>
					<img
						style="
							width: 88.8px;
							height: 56.8px;
							left: 0px;
							top: 0.8px;
							position: absolute;
						"
						src="{{ url_for('static', filename='images/01_logobachkhoatoi 1.png') }}" />
					<div
						style="
							width: 178px;
							height: 49px;
							left: 85px;
							top: 0px;
							position: absolute;
							color: white;
							font-size: 22.4px;
							font-family: Montserrat;
							font-weight: 700;
							word-wrap: break-word;
						">
						Student Smart Printing Service
					</div>
				</div>
				<div class="nav-block">
					<script>
						function openMenu(x) {
							x.classList.toggle("change");
							const menu = document.getElementById("menu");
							if (menu.classList.contains("appear")) {
								menu.classList.remove("appear");
							} else {
								menu.classList.add("appear");
							}
						}
					</script>
					<div id="menu-icon" onclick="openMenu(this)">
						<div id="bar1"></div>
						<div id="bar2"></div>
						<div id="bar3"></div>
					</div>
					<ul id="menu">
						<li onClick="window.location.href='index';">TRANG CHỦ</li>
						<li onClick="window.location.href='student_dashboard';">
							BẢNG ĐIỀU KHIỂN
						</li>
						<li
							onClick="window.location.href='upload_file';"
							class="index-page">
							IN TÀI LIỆU
						</li>
						<li onClick="window.location.href='printing_history';">
							LỊCH SỬ IN
						</li>
						<li onClick="window.location.href='buy_paper';">MUA THÊM GIẤY</li>
					</ul>
				</div>
				<div id="noti-account">
					<div id="noti">
						<svg
							id="circle"
							width="18"
							height="20"
							viewBox="0 0 18 20"
							fill="none"
							xmlns="http://www.w3.org/2000/svg">
							<path
								id="Vector"
								d="M12 15V16C12 17.6569 10.6569 19 9 19C7.34315 19 6 17.6569 6 16V15M12 15H6M12 15H15.5905C15.973 15 16.1652 15 16.3201 14.9478C16.616 14.848 16.8475 14.6156 16.9473 14.3198C16.9997 14.1643 16.9997 13.9715 16.9997 13.5859C16.9997 13.4172 16.9995 13.3329 16.9863 13.2524C16.9614 13.1004 16.9024 12.9563 16.8126 12.8312C16.7651 12.7651 16.7048 12.7048 16.5858 12.5858L16.1963 12.1963C16.0706 12.0706 16 11.9001 16 11.7224V8C16 4.134 12.866 0.999991 9 1C5.13401 1.00001 2 4.13401 2 8V11.7224C2 11.9002 1.92924 12.0706 1.80357 12.1963L1.41406 12.5858C1.29476 12.7051 1.23504 12.765 1.1875 12.8312C1.09766 12.9564 1.03815 13.1004 1.0132 13.2524C1 13.3329 1 13.4172 1 13.586C1 13.9715 1 14.1642 1.05245 14.3197C1.15225 14.6156 1.3848 14.848 1.68066 14.9478C1.83556 15 2.02701 15 2.40956 15H6"
								stroke="black"
								stroke-width="1.6"
								stroke-linecap="round"
								stroke-linejoin="round" />
						</svg>
						<svg
							id="bell"
							width="42"
							height="41"
							viewBox="0 0 42 41"
							fill="none"
							xmlns="http://www.w3.org/2000/svg">
							<path
								id="Ellipse 3230"
								d="M41 20.5C41 31.5457 32.0457 40.5 21 40.5C9.9543 40.5 1 31.5457 1 20.5C1 9.4543 9.9543 0.5 21 0.5C32.0457 0.5 41 9.4543 41 20.5Z"
								stroke="black" />
						</svg>
						<div id="notification-box" class="hidden">
							<div class="notification-header">Thông báo</div>
							<ul class="notification-list">
								{% if notifications %}
									{% for notification in notifications %}
									<li>
										<span class="notification-title">Thông báo {{ loop.index }}</span> <!-- Hiển thị số thứ tự thông báo -->
										<p>{{ notification[0] }}</p> <!-- Nội dung thông báo -->
										<div class="notification-footer">
											<span class="notification-time">{{ notification[1] }}</span> <!-- Thời gian thông báo -->
											<button class="notification-detail-btn">Xem chi tiết</button>
										</div>
									</li>
									{% endfor %}
								{% else %}
									<li>
										<p>Không có thông báo nào.</p> <!-- Thông báo khi không có dữ liệu -->
									</li>
								{% endif %}
							</ul>
						</div>
					</div>
					<div class="info-list">
						<ul>
							<li>
								<img src="data:image/png;base64,{{ profile_picture3_base64 }}" class="profile-img" alt="Profile Picture">
								<div class="name">{{ name }}</div>
								<ul class="dropdown">
									<li><a>Hồ sơ</a></li>
									<li>
										<a>Ngôn ngữ</a>
										<ul class="nextpage">
											<li>Tiếng Việt</li>
											<li>English</li>
										</ul>
									</li>
									<li><a href="/">Đăng xuất</a></li>
								</ul>
								<svg
									style="padding: 0 10px, 0 10px"
									width="10"
									height="5"
									viewBox="0 0 12 8"
									fill="none"
									xmlns="http://www.w3.org/2000/svg"
									style="margin-left: -5px">
									<path
										d="M1 1L6 6L11 1"
										stroke="black"
										stroke-width="1.6"
										stroke-linecap="round"
										stroke-linejoin="round" />
								</svg>
							</li>
						</ul>
					</div>
				</div>
			</div>
		<!-- print box -->
		

		<div class="parent">
			<div class="div1">
				<div id ='preview-box' class="div2">
					<div >
						<embed id="preview-frame" style="width: 55%; height: 610px;" frameborder="0">
						</embed>
					</div>
				</div>
			</div>
			<div class="div3">
				<div id = "general-info">
					<table class="general-table" style="width: 100%;">
						<tr>
							<td colspan="2">
								<h3>THÔNG TIN CHUNG</h3>
							</td>
						</tr>
						<tr>
							<td>TÊN TÀI LIỆU:</td>
							<td id="file-name"></td>
						</tr>
						<tr>
							<td> ĐỊNH DẠNG:</td>
							<td id="file-type"></td>
						</tr>
						<tr>
							<td> KÍCH THƯỚC: </td>
							<td id="file-size"></td>
						</tr>
					</table>
				</div>
				<br />
				<br />
				<div id="configuration">
					<h3>TUỲ CHỌN IN ẤN</h3>
					<form id="form" method="POST">
						<div class="fill">
							<label for="paper_type">CỠ GIẤY:</label>
							<select id="paper_type">
								<option>A4</option>
								<option>A3</option>
								</select
							><br />
						</div>
						<div class="fill">
							<label for="num_copies">SỐ BẢN:</label>
							<input
								type="number"
								id="num_copies"
								min="0"
								max="100"
								required /><br />
						</div>
						<div class="fill">
							<label for="page_range">SỐ TRANG:</label>
							<input
								type="text"
								id="pageRange"
								placeholder="  VD: 1 - 10"
								required /><br />
						</div>
						<div class="fill">
							<label for="print_sides">SỐ MẶT:</label>
							<select id="print_sides">
								<option>1 mặt</option>
								<option>2 mặt</option>
								<option>4 mặt</option>
								<option>6 mặt</option>
								<option>9 mặt</option>
								<option>16 mặt</option>
								</select
							><br />
						</div>
						<div class="fill">
							<label for="paper_orientation">KHỔ:</label>
							<select id="paper_orientation">
								<option>Dọc</option>
								<option>Ngang</option>
								</select
							><br />
						</div>
						<div class="submit">
							<input id="back-button" value="Quay lại"  onClick="window.location.href='upload_file';"/>
							<input type="button" id="next-button" value="Tiếp tục" />
						</div>
						<div class="popup-overlay" id="popupOverlay" style="display: none;">
							<div class="popup" id="popup" >
						
								<span class="close" id="closePopup">&times;</span>
								<div class="popup-content">
									<h3>CHỌN MÁY IN</h3>
									<table id="printer-table" border="1">
										<thead>
											<tr>
												<th>Cơ sở</th>
												<th>Toà</th>
												<th>Máy in</th>
												<th>Phòng</th>
											</tr>
										</thead>
										<tbody>
											<!-- Printer rows will be dynamically added here -->
										</tbody>
									</table>
									<input type="hidden" id="selected-printer-id" name="printer_id" value="">	
									</br>				
									<input type="submit" id="submitButton" value="Xác nhận" disabled/>
								</div>
							</div>		
						</div>
					</form>
					<script>
						const popupOverlay = document.getElementById('popupOverlay');
						const popup = document.getElementById('popup');
						const closePopup = document.getElementById('closePopup');
						function closePopupFunc() {
							popupOverlay.style.display = 'none';
						}

						
						async function fetchAndDisplayPrinters() {
							try {
								document.getElementById('popupOverlay').style.display = 'block';
								closePopup.addEventListener('click', closePopupFunc);
								popupOverlay.addEventListener('click', function (event) {
									if (event.target === popupOverlay) {
										closePopupFunc();
									}
								});
								// Fetch printer data from the backend
								const response = await fetch('/choose_printer');
								
								// Check if the response is okay
								if (!response.ok) {
									throw new Error('Failed to fetch printer data');
								}

								// Parse the JSON response
								const printers = await response.json();

								// Reference to the table body
								const tableBody = document.getElementById('printer-table').querySelector('tbody');

								// Clear existing rows
								tableBody.innerHTML = '';

								// Loop through printers and create rows
								printers.forEach(printer => {
									const row = document.createElement('tr');
									row.dataset.printerId = printer.printer_id;

									// Create cells for each piece of data
									Object.values(printer).forEach(value => {
										const cell = document.createElement('td');
										cell.textContent = value;
										row.appendChild(cell);
									});

									// Add click event to select the row
									row.addEventListener('click', () => toggleSelection(row));

									// Append the row to the table body
									tableBody.appendChild(row);
								});
							} catch (error) {
								console.error('Error:', error);
								alert('Failed to load printer data. Please try again later.');
							}
						}

						// Function to handle printer selection
						function toggleSelection(row) {
							const selectedPrinterId = row.dataset.printerId;
							const currentlySelectedRow = document.querySelector('.selected');

							// If the clicked row is already selected, deselect it
							if (currentlySelectedRow === row) {
								row.classList.remove('selected');
								document.getElementById('selected-printer-id').value = ''; 
								document.getElementById('submitButton').disabled = true;
							} else {
								// Otherwise, select the new row and deselect the old one
								if (currentlySelectedRow) {
									currentlySelectedRow.classList.remove('selected');
								}

								row.classList.add('selected');
								document.getElementById('selected-printer-id').value = selectedPrinterId; // Set the selected printer ID
								document.getElementById('submitButton').disabled = false; // Enable the submit button
							}
						}						
						document.getElementById('form').addEventListener('submit', function(event) {
							event.preventDefault();

							const selectedPrinterId = document.getElementById('selected-printer-id').value;

							if (selectedPrinterId) {
								alert('Gửi yêu cầu in thành công!');
								this.submit();
								// alert('Chọn thành công');
							} else {
								alert('Xin hãy chọn một máy in!');
							}
						});
						
						document.getElementById('next-button').addEventListener('click', fetchAndDisplayPrinters);
					</script>
				</div>
			</div>
		</div>
		<script>
			// Fetch the file and display it in the iframe
			const previewFrame = document.getElementById('preview-frame');
			let contentType = 'application/pdf';
			fetch('/serve_file')
				.then(response => {
					if (!response.ok) {
						throw new Error('File not found');
					}
					document.getElementById('file-name').textContent = response.headers.get('file_name');
					document.getElementById('file-type').textContent = response.headers.get('file_type');
					document.getElementById('file-size').textContent = response.headers.get('file_size');
					return response.blob();
				})
				.then(blob => {
					// Create a URL for the blob and set it as iframe source
					const fileURL = URL.createObjectURL(blob);
					previewFrame.src = fileURL;
					previewFrame.type = contentType;
				})
				.catch(error => console.error('Error fetching file:', error));
		</script>
	
		<script>
			// Function to simulate saving the configuration to the database
			function saveConfiguration() {
				// Collect the content of the print preview section
				const content = document.getElementById('print-preview').innerHTML;
	
				// Example of sending the content to the backend (Flask API call)
				fetch('http://localhost:5000/save-print-config', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({ content: content })
				})
				.then(response => response.json())
				.then(data => {
					console.log('Configuration saved:', data);
					alert('Configuration saved successfully!');
				})
				.catch(error => {
					console.error('Error saving configuration:', error);
					alert('Failed to save configuration.');
				});
			}
		</script>
		<!-- chatbox -->

		<div class="chat-bar" id="chat-bar">
			<img
				src="{{ url_for('static', filename='images/01_logobachkhoatoi 1.png') }}" />
			<span>Chat tư vấn - Giải đáp mọi thắc mắc</span>
		</div>
		<div class="chat-box" id="chat-box">
			<div class="chat-header">
				<div class="chat-header-left">
					<img
						src="{{ url_for('static', filename='images/01_logobachkhoatoi 1.png') }}" />
					<span>Liên hệ SPSO</span>
				</div>
				<button id="close-chat">✖</button>
			</div>
			<div class="chat-content">
				<div class="chat-message">
					<img
						src="{{ url_for('static', filename='images/01_logobachkhoatoi 1.png') }}" />
					<p>
						Nếu bạn cần hỗ trợ gì cho việc in ấn thì có thể nhắn vào khung
						chat để được giúp đỡ. SPSO sẽ liên lạc lại sớm nhất có thể
					</p>
				</div>
			</div>
			<div class="chat-input">
				<textarea placeholder="Nhập nội dung..."></textarea>
				<button id="send-message">Gửi</button>
			</div>
		</div>
		<script>
			const chatBar = document.getElementById("chat-bar");
			const chatBox = document.getElementById("chat-box");
			const closeChat = document.getElementById("close-chat");

			// Hiển thị khung chat và ẩn thanh chat bar
			chatBar.addEventListener("click", () => {
				chatBox.classList.add("show");
				chatBar.style.display = "none"; // Ẩn thanh chat bar
			});
			// Ẩn khung chat và hiển thị lại thanh chat bar
			closeChat.addEventListener("click", () => {
				chatBox.classList.remove("show");
				chatBar.style.display = "flex"; // Hiển thị lại thanh chat bar
			});
			// Xử lý hiển thị/ẩn bảng thông báo khi nhấn vào chuông
			document.getElementById("noti").addEventListener("click", function (e) {
				e.stopPropagation();
				const notificationBox = document.getElementById("notification-box");
				notificationBox.classList.toggle("active");
			  });
		
			  document.addEventListener("click", function (e) {
				const notificationBox = document.getElementById("notification-box");
				const noti = document.getElementById("noti");
				if (!noti.contains(e.target) && !notificationBox.contains(e.target)) {
				  notificationBox.classList.remove("active");
				}
			  });
		
			  document
				.getElementById("notification-box")
				.addEventListener("click", function (e) {
				  e.stopPropagation();
				});	
		</script>
	</body>
</html>
